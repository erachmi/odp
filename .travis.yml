# Copyright (c) 2016, Linaro Limited
# All rights reserved.
# SPDX-License-Identifier:     BSD-3-Clause
#
# Please update xxxx for your coverity token and notification email if required
# pushing to github/master will run make check
# pushing to github/coverity_scan will also launch a static analysis
# See https://scan.coverity.com/travis_ci

env:
  global:
    # COVERITY_SCAN_TOKEN
    # ** specific to your project **
    - secure: "c8aqZwuYNjbfOZ4CutpBgoMHxm73kj+XJX4I7kcAyZl9vyezOLFwhgjps1Y7WNsdqAXxJgx6Bzxl0/y/qS5EiJ48pRCL04DBdiLEJ66uR6A1v3M9/jkxxEpFGW2et11T35V99ui9tS85W6q6BKfhSe2H+gcaHfb2W0k0gzpqoFMOKUDYujxoFg014bmgD7q2VbLjfLgC5BDUm8+0EK7qAWE/FEr0By2bga7S7EOc+k4mTh8dj0O9eQqP6IgU2uDHRcM7vTY/hLX/H2ykA0t5wFTulhDhASxXrsMwv4OGdsjaNF36rjEFeRXjweFKzID9jZaqjtWmYU3dh/blLWTj+XRqx8b3VxLYx+LHcddSPhi5u+P2DHIdhM43BEyZ4EwdjdZn3zsrfCflK1CCvBDn6l/e8kupADVm8udWvB7w/MwotwW4Y6ZqKrDgScQsNhYXu97sbOR4RkK5Xmdnw5dT6s7225yqUYTLEWNdVmYFgVgRMe0iicHeLdWmh1veF5gB0TTIiWJoCVOvzdeE4V7ch/C5B58qvU0U5bmiA+g8BSFAZs1To49PMuIpQhVmUqWtouvZQkWUlrvjWfzl1TD2x5ChGAhMSViVIOB0oLE5m+2mJ1K0cqLoVeY53uxWg7vwpk7DeTt9dKq8gB2NtORPlpN/6csrlkhiSZ+/9nGykUI="

language: c
compiler: clang
sudo: required

before_install:
        - sudo apt-get -qq update
        - sudo apt-get install automake autoconf libtool libssl-dev graphviz mscgen doxygen
        - sudo apt-get install libpcap-dev linux-headers-`uname -r`
        - gem install asciidoctor

#       Install cunit for the validation tests because distro version is too old and fails C99 compile
        - export CUNIT_VERSION=2.1-3
        - curl -sSOL http://sourceforge.net/projects/cunit/files/CUnit/${CUNIT_VERSION}/CUnit-${CUNIT_VERSION}.tar.bz2
        - tar -jxf *.bz2
        - cd CUnit*
        - ./bootstrap
        - ./configure --enable-debug --enable-automated --enable-basic --enable-console --enable-examples --enable-test
        - make
        - sudo make install
        - cd ..
        - export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
#	DPDK pktio
        - TARGET=${TARGET:-"x86_64-native-linuxapp-gcc"}
        - git -c advice.detachedHead=false clone -q --depth=1 --single-branch --branch=v16.07 http://dpdk.org/git/dpdk dpdk
        - pushd dpdk
        - git log --oneline --decorate
        - make config T=${TARGET} O=${TARGET}
        - pushd ${TARGET}
        - sed -ri 's,(CONFIG_RTE_LIBRTE_PMD_PCAP=).*,\1y,' .config
        - popd
        - make install T=${TARGET} EXTRA_CFLAGS="-fPIC" > /dev/null
        - popd

script:

        - ./bootstrap
        - ./configure --enable-test-cpp --enable-test-vald --enable-test-helper --enable-test-perf --enable-user-guides --enable-test-perf-proc --enable-test-example --with-dpdk-path=`pwd`/dpdk/${TARGET}
        - make check
        - git clean -f -d -x && rm -rf dpdk
        - ./bootstrap
        - ./configure
        - make doxygen-doc
        - make distcheck

addons:
    coverity_scan:
        project:
            name: "$TRAVIS_REPO_SLUG"
        notification_email: xxxx
        build_command_prepend: "./bootstrap && ./configure --enable-test-cpp --enable-test-vald --enable-test-helper --enable-test-perf --enable-user-guides --enable-test-perf-proc --enable-test-example"
        build_command:   "make"
        branch_pattern: coverity_scan
